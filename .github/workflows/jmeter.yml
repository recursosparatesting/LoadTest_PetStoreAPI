name: Performance Test Pipeline

on:
  workflow_dispatch:
    inputs:
      aut_repo:
        description: 'URL del repositorio pÃºblico de la aplicaciÃ³n bajo prueba (PetStore)'
        required: true
        default: 'https://github.com/swagger-api/swagger-petstore.git'

      jmx_file:
        description: 'Nombre del archivo .jmx de JMeter'
        required: true
        default: 'LoadTest_PetStoreApi.jmx'

jobs:
  performance_run:
    runs-on: ubuntu-24.04
    env:
      JMETER_VERSION: 5.6.3
      JMETER_HOME: ${{ github.workspace }}/apache-jmeter-5.6.3

    steps:
      - name: âš™ï¸ Checkout del Robot (Este Repositorio)
        uses: actions/checkout@v4

      - name: ğŸ“¦ Instalar Maven y Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: â¬‡ï¸ Download and Setup Apache JMeter
        run: |
         wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${{ env.JMETER_VERSION }}.zip
         unzip apache-jmeter-${{ env.JMETER_VERSION }}.zip
         echo "${{ env.JMETER_HOME }}/bin" >> $GITHUB_PATH

      - name: ğŸ§© Install JMeter Plugins Manager and Required Plugins
        run: |
          PLUGINS_MANAGER_JAR="jmeter-plugins-manager-1.9.jar"
          PLUGINS_MANAGER_URL="https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/1.9/jmeter-plugins-manager-1.9.jar"
          
          echo "Descargando Plugins Manager JAR..."
          wget https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/1.9/jmeter-plugins-manager-1.9.jar -P ${{ env.JMETER_HOME }}/lib/ext/
        
          wget https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar -P ${{ env.JMETER_HOME }}/lib/
            
          java -cp ${{ env.JMETER_HOME }}/lib/ext/jmeter-plugins-manager-1.9.jar org.jmeterplugins.repository.PluginManagerCMDInstaller
          echo "Instalando plugins requeridos usando ${PLUGINS_CMD_PATH}..."
          chmod +x ${{ env.JMETER_HOME }}/bin/PluginsManagerCMD.sh
          ${{ env.JMETER_HOME }}/bin/PluginsManagerCMD.sh install jpgc-casutg,jpgc-perfmon,jpgc-standard

      - name: ğŸ“¥ Clonar y compilar la AUT
        run: |
          git clone ${{ github.event.inputs.aut_repo }} aut_repo

      - name: ğŸš€ Ejecutar la AUT en segundo plano
        run: |
            # El 'mvn package jetty:run' inicia el servidor en segundo plano
            cd aut_repo
            nohup mvn package jetty:run &> aut.log &
            cd ..
            echo "La AUT se estÃ¡ iniciando en segundo plano. Esperando..."

      - name: â±ï¸ Esperar a que la AUT estÃ© disponible (Health Check)
        uses: nev7n/wait_for_response@v1
        with:
                # URL por defecto de la aplicaciÃ³n PetStore con Jetty
                url: http://localhost:8080/api/v3/openapi.json
                timeout: 180000
                interval: 5000
                responseCode: 200

      - name: ğŸš€ Setup and Start PerfMon ServerAgent
        run: |
          # Descargar el agente que monitorea el servidor
          wget https://github.com/undera/perfmon-agent/releases/download/2.2.3/ServerAgent-2.2.3.zip
          unzip ServerAgent-2.2.3.zip -d server-agent
          mv server-agent/ServerAgent-2.2.3/* server-agent/
          chmod +x server-agent/startAgent.sh
          
          # EJECUTAR EN SEGUNDO PLANO (&) para que no bloquee el pipeline
          # Usamos nohup para que siga corriendo aunque el shell se cierre
          nohup ./server-agent/startAgent.sh --udp-port 0 --tcp-port 4444 > agent.log 2>&1 &
          
          # Esperar un par de segundos a que el agente inicie
          sleep 5

      - name: ğŸƒ Ejecutar Pruebas de Carga con JMeter
        run: |
            # Asegurarse de que el directorio de resultados existe
            mkdir -p results
            mkdir -p results/html_report
            
            # La variable de entorno JMETER_HOME estÃ¡ disponible gracias al paso anterior
            # Ejecutamos jmeter.sh usando la ruta completa
            jmeter.sh -n -t ${{ github.event.inputs.jmx_file }} \
                   -Jresults_path=results -l results/results.jtl  -e -o results/html_report 
          
      - name: ğŸ“¤ Upload Performance Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            results/
          include-hidden-files: true

      - name: ğŸ“¤ Upload Performance Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            results/html_report
          include-hidden-files: true